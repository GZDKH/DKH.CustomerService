name: Auto Release and Publish

on:
  push:
    branches:
      - 'release/**'
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  SOLUTION_NAME: "DKH.CustomerService"
  CONTRACTS_PROJECT: "DKH.CustomerService.Contracts/DKH.CustomerService.Contracts.csproj"
  PACKAGE_NAME: "DKH.CustomerService.Contracts"
  NUGET_OUTPUT: "${{ github.workspace }}/nupkg"

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  pr-validation:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore and Build Contracts
        env:
          GITHUB_NUGET_USERNAME: ${{ github.actor }}
          GITHUB_NUGET_TOKEN: ${{ secrets.NUGET_PACKAGE_TOKEN }}
        run: |
          dotnet nuget update source github-dotnet-gzdkh \
            --username $GITHUB_NUGET_USERNAME \
            --password $GITHUB_NUGET_TOKEN \
            --store-password-in-clear-text
          dotnet restore ${{ env.CONTRACTS_PROJECT }}
          dotnet build ${{ env.CONTRACTS_PROJECT }} -c Release --no-restore

  release-and-publish:
    if: github.event_name == 'push' && startsWith(github.ref_name, 'release/')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from branch name
        id: version
        run: echo "value=${GITHUB_REF_NAME#release/}" >> $GITHUB_OUTPUT

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore and Build Contracts
        env:
          GITHUB_NUGET_USERNAME: ${{ github.actor }}
          GITHUB_NUGET_TOKEN: ${{ secrets.NUGET_PACKAGE_TOKEN }}
        run: |
          dotnet nuget update source github-dotnet-gzdkh \
            --username $GITHUB_NUGET_USERNAME \
            --password $GITHUB_NUGET_TOKEN \
            --store-password-in-clear-text
          dotnet restore ${{ env.CONTRACTS_PROJECT }}
          dotnet build ${{ env.CONTRACTS_PROJECT }} -c Release --no-restore

      - name: Pack Contracts
        run: |
          mkdir -p ${{ env.NUGET_OUTPUT }}
          dotnet pack ${{ env.CONTRACTS_PROJECT }} -c Release --no-build \
            -o ${{ env.NUGET_OUTPUT }} \
            /p:PackageVersion=${{ steps.version.outputs.value }}

      - name: Delete existing package version
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION_ID=$(gh api user/packages/nuget/${{ env.PACKAGE_NAME }}/versions \
            --jq '.[] | select(.name == "${{ steps.version.outputs.value }}") | .id' 2>/dev/null || echo "")
          if [ -n "$VERSION_ID" ]; then
            gh api -X DELETE user/packages/nuget/${{ env.PACKAGE_NAME }}/versions/$VERSION_ID
            echo "Deleted existing package version $VERSION_ID"
          fi

      - name: Publish to GitHub Packages
        env:
          GITHUB_NUGET_TOKEN: ${{ secrets.NUGET_PACKAGE_TOKEN }}
        run: |
          dotnet nuget push ${{ env.NUGET_OUTPUT }}/*.nupkg \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --api-key $GITHUB_NUGET_TOKEN

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.value }}
          name: Release v${{ steps.version.outputs.value }}
          generate_release_notes: true
          files: |
            ${{ env.NUGET_OUTPUT }}/*.nupkg
            ${{ env.NUGET_OUTPUT }}/*.snupkg
